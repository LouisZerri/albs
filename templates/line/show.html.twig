{% extends 'base.html.twig' %}

{% block title %}Ligne
	{{ line.number }}
	- Ã€ la bonne station
{% endblock %}

{% block body %}
	<div
		class="w-full px-4 py-6">
		{# En-tÃªte de la ligne #}
		<div class="bg-white rounded-xl shadow-lg p-4 sm:p-8 mb-4 sm:mb-8">
			<div class="flex items-center justify-between mb-4 sm:mb-6">
				<div class="flex items-center space-x-3 sm:space-x-6">
					<div class="inline-flex items-center justify-center w-16 h-16 sm:w-28 sm:h-28 rounded-full text-white font-bold text-3xl sm:text-6xl shrink-0" style="background-color: {{ line.color }}; color: {{ line.textColor }};">
						{% if 'bis' in line.number %}
							{{ line.number|replace({'bis': ''}) }}<span class="text-lg sm:text-3xl">bis</span>
						{% else %}
							{{ line.number }}
						{% endif %}
					</div>
					<div>
						<h1 class="text-xl sm:text-4xl font-bold text-gray-900 mb-1">Ligne
							{{ line.number }}</h1>
						<p class="text-sm sm:text-xl text-gray-600">{{ line.name }}</p>
						<p class="text-xs sm:text-base text-gray-500 mt-1">{{ stats.total }}
							stations au total</p>
					</div>
				</div>
				<a href="{{ path('app_lines') }}" class="hidden sm:block text-blue-600 hover:text-blue-800 font-medium text-lg">
					â† Retour aux lignes
				</a>
			</div>

			{# Statistiques de progression #}
			<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-6">
				<div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 sm:p-6 relative overflow-hidden border border-blue-200 hover:shadow-xl hover:scale-[1.02] transition-all duration-300">
					<div class="flex items-center justify-between mb-2 sm:mb-4">
						<div>
							<p class="text-blue-600 text-xs sm:text-sm font-medium mb-1 sm:mb-2">Stations passÃ©es</p>
							<p class="text-2xl sm:text-4xl font-black text-blue-700">
								<span id="passed-count">{{ stats.passed }}</span>/{{ stats.total }}
							</p>
							<p class="text-xs text-blue-500 mt-1 hidden sm:block">Tu as traversÃ© ces stations</p>
						</div>
						<div class="text-4xl sm:text-6xl animate-float">ğŸš¶</div>
					</div>
					<div class="mt-2 sm:mt-4 bg-blue-200 rounded-full h-5 sm:h-6">
						<div id="passed-bar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-5 sm:h-6 rounded-full transition-all duration-500 flex items-center justify-end overflow-visible" style="width: {{ max(min(stats.passedPercentage, 96), 4) }}%;">
							<span class="text-2xl sm:text-3xl leading-none -mr-1">ğŸš‡</span>
						</div>
					</div>
					<p class="text-xs sm:text-sm text-blue-600 mt-1 sm:mt-2 font-semibold">
						<span id="passed-percentage">{{ stats.passedPercentage|round(0) }}</span>%</p>
				</div>

				<div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-xl p-4 sm:p-6 relative overflow-hidden border border-green-200 hover:shadow-xl hover:scale-[1.02] transition-all duration-300">
					<div class="flex items-center justify-between mb-2 sm:mb-4">
						<div>
							<p class="text-green-600 text-xs sm:text-sm font-medium mb-1 sm:mb-2">Stations visitÃ©es</p>
							<p class="text-2xl sm:text-4xl font-black text-green-700">
								<span id="stopped-count">{{ stats.stopped }}</span>/{{ stats.total }}
							</p>
							<p class="text-xs text-green-500 mt-1 hidden sm:block">Tu t'y es arrÃªtÃ©(e)</p>
						</div>
						<div class="text-4xl sm:text-6xl animate-float" style="animation-delay: 0.5s;">âœ…</div>
					</div>
					<div class="mt-2 sm:mt-4 bg-green-200 rounded-full h-5 sm:h-6">
						<div id="stopped-bar" class="bg-gradient-to-r from-green-500 to-emerald-600 h-5 sm:h-6 rounded-full transition-all duration-500 flex items-center justify-end overflow-visible" style="width: {{ max(min(stats.stoppedPercentage, 96), 4) }}%;">
							<span class="text-2xl sm:text-3xl leading-none -mr-1">ğŸš‡</span>
						</div>
					</div>
					<p class="text-xs sm:text-sm text-green-600 mt-1 sm:mt-2 font-semibold">
						<span id="stopped-percentage">{{ stats.stoppedPercentage|round(0) }}</span>%</p>
				</div>
			</div>
		</div>

		{# Vue verticale de la ligne de mÃ©tro #}
		<div class="bg-white rounded-xl shadow-lg p-3 sm:p-10">
			<div class="mb-4 sm:mb-8">
				<h2 class="text-xl sm:text-3xl font-bold text-gray-900 mb-2">Parcours de la ligne</h2>
				<p class="text-sm sm:text-lg text-gray-600">Cliquez sur les cercles pour marquer votre progression</p>
				<div class="flex items-center gap-2 sm:gap-4 mt-2 text-xs sm:text-sm text-gray-500">
					<span class="flex items-center gap-1">
						<span class="w-3 h-3 rounded-full bg-white border-2" style="border-color: {{ line.color }};"></span>
						Non visitÃ©</span>
					<span class="flex items-center gap-1">
						<span class="w-3 h-3 rounded-full bg-blue-400 border-2" style="border-color: {{ line.color }};"></span>
						PassÃ©</span>
					<span class="flex items-center gap-1">
						<span class="w-3 h-3 rounded-full bg-green-500 border-2" style="border-color: {{ line.color }};"></span>
						VisitÃ©</span>
				</div>
			</div>

			{# DonnÃ©es pour le JS #}
			<div id="line-stats" data-total="{{ stats.total }}" data-passed="{{ stats.passed }}" data-stopped="{{ stats.stopped }}"></div>

			{# Ligne verticale avec stations #}
			<div
				class="relative">
				{# Branche Saint-Denis (ligne 13) #}
				{% if hasFork and branchStations['saint-denis'] is defined %}
					<div class="my-4 flex justify-center">
						<span class="inline-block bg-purple-100 text-purple-800 px-4 py-2 rounded-xl font-semibold text-sm shadow-md">
							ğŸ”€ Branche Saint-Denis
						</span>
					</div>
					{% for station in branchStations['saint-denis'] %}
						{{ _self.render_station(station, line, userStations, loop.first, false, 'purple', loop.first, loop.last) }}
					{% endfor %}
				{% endif %}

				{# Branche AsniÃ¨res (ligne 13) #}
				{% if hasFork and branchStations['asnieres'] is defined %}
					<div class="my-4 flex justify-center">
						<span class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-xl font-semibold text-sm shadow-md">
							ğŸ”€ Branche AsniÃ¨res
						</span>
					</div>
					{% for station in branchStations['asnieres'] %}
						{{ _self.render_station(station, line, userStations, loop.first, false, 'indigo', loop.first, loop.last) }}
					{% endfor %}
				{% endif %}

				{# Toutes les stations (mainStations) #}
				{% if mainStations is defined %}
					{% for station in mainStations %}
						{% set isTerminus = (loop.first and station.branch != 'fork') or (loop.last and station.branch != 'fork') %}
						{{ _self.render_station(station, line, userStations, isTerminus, station.branch == 'fork', 'gray', loop.first, loop.last) }}
					{% endfor %}
				{% endif %}

				{# Branche Villejuif (ligne 7) #}
				{% if hasFork and branchStations['villejuif'] is defined %}
					<div class="my-4 flex justify-center">
						<span class="inline-block bg-purple-100 text-purple-800 px-4 py-2 rounded-xl font-semibold text-sm shadow-md">
							ğŸ”€ Branche Villejuif
						</span>
					</div>
					{% for station in branchStations['villejuif'] %}
						{{ _self.render_station(station, line, userStations, loop.last, false, 'purple', loop.first, loop.last) }}
					{% endfor %}
				{% endif %}

				{# Branche Ivry (ligne 7) #}
				{% if hasFork and branchStations['ivry'] is defined %}
					<div class="my-4 flex justify-center">
						<span class="inline-block bg-indigo-100 text-indigo-800 px-4 py-2 rounded-xl font-semibold text-sm shadow-md">
							ğŸ”€ Branche Ivry
						</span>
					</div>
					{% for station in branchStations['ivry'] %}
						{{ _self.render_station(station, line, userStations, loop.last, false, 'indigo', loop.first, loop.last) }}
					{% endfor %}
				{% endif %}
			</div>

			{# LÃ©gende desktop #}
			<div class="mt-8 hidden sm:flex justify-center items-center space-x-10 text-base">
				<div class="flex items-center space-x-3">
					<div class="w-5 h-5 rounded-full border-4 bg-gray-900" style="border-color: {{ line.color }};"></div>
					<span class="text-gray-600 font-medium">Terminus ğŸš‡</span>
				</div>
				<div class="flex items-center space-x-3">
					<div class="w-5 h-5 rounded-full border-4 bg-white" style="border-color: {{ line.color }};"></div>
					<span class="text-gray-600 font-medium">Non visitÃ©</span>
				</div>
				<div class="flex items-center space-x-3">
					<div class="w-5 h-5 rounded-full border-4 bg-blue-400" style="border-color: {{ line.color }};"></div>
					<span class="text-gray-600 font-medium">PassÃ©</span>
				</div>
				<div class="flex items-center space-x-3">
					<div class="w-5 h-5 rounded-full border-4 bg-green-500" style="border-color: {{ line.color }};"></div>
					<span class="text-gray-600 font-medium">VisitÃ©</span>
				</div>
			</div>
		</div>

		{# Bouton retour fixe sur mobile #}
		<a href="{{ path('app_lines') }}" class="sm:hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl font-medium z-50 flex items-center gap-2">
			<span>â†</span>
			Retour
		</a>

		{# Spacer pour le bouton fixe sur mobile #}
		<div class="h-16 sm:hidden"></div>
	</div>

	{# Macro pour afficher une station #}
	{% macro render_station(station, line, userStations, isTerminus, isFork, branchColor, isFirst, isLast) %}
		{% set isPassed = userStations[station.id] is defined and userStations[station.id].passed %}
		{% set isStopped = userStations[station.id] is defined and userStations[station.id].stopped %}

		<div
			class="flex items-stretch" data-controller="station" data-station-id="{{ station.id }}" data-station-line-id="{{ line.id }}" data-station-passed="{{ isPassed ? 'true' : 'false' }}" data-station-stopped="{{ isStopped ? 'true' : 'false' }}" data-station-terminus="{{ isTerminus ? 'true' : 'false' }}">

			{# Colonne de gauche : ligne verticale + cercle #}
			<div
				class="flex flex-col items-center shrink-0 w-10 sm:w-16">
				{# Trait du haut #}
				<div class="w-1 flex-1 {% if isFirst %}bg-transparent{% endif %}" style="{% if not isFirst %}background-color: {{ line.color }};{% endif %}"></div>

				{# Cercle cliquable #}
				<div data-station-target="circle" data-action="click->station#cycle" class="w-8 h-8 sm:w-7 sm:h-7 rounded-full border-4 shrink-0 transition-all duration-200 ring-4 cursor-pointer active:scale-90 hover:scale-110
					{% if isTerminus %}
						{% if isStopped %}
							bg-green-600 ring-green-300
						{% elseif isPassed %}
							bg-blue-500 ring-blue-300
						{% else %}
							bg-gray-900 ring-transparent
						{% endif %}
					{% elseif isStopped %}
						bg-green-500 ring-green-200
					{% elseif isPassed %}
						bg-blue-400 ring-blue-200
					{% else %}
						bg-white ring-transparent
					{% endif %}" style="border-color: {{ line.color }};"></div>

				{# Trait du bas #}
				<div class="w-1 flex-1 {% if isLast %}bg-transparent{% endif %}" style="{% if not isLast %}background-color: {{ line.color }};{% endif %}"></div>
			</div>

			{# Contenu de la station #}
			<div class="flex-grow py-2 sm:py-3 pl-2 sm:pl-4 min-w-0">
				<div class="rounded-xl px-3 sm:px-6 py-3 sm:py-4 transition duration-150
					{% if branchColor == 'purple' %}
						bg-purple-50 border-l-4 border-purple-400
					{% elseif branchColor == 'indigo' %}
						bg-indigo-50 border-l-4 border-indigo-400
					{% else %}
						bg-gray-50
					{% endif %}">
					<div class="flex items-center justify-between gap-2">
						<div class="min-w-0 flex-grow">
							<h3 class="text-sm sm:text-lg {% if isTerminus %}font-black{% else %}font-medium{% endif %} text-gray-900 truncate">
								{{ station.name }}
							</h3>
							<div class="flex items-center gap-2 mt-0.5">
								{% if isTerminus %}
									<span class="text-xs sm:text-sm text-gray-500">ğŸš‡ Terminus</span>
									<span data-station-target="statusText" class="text-xs sm:text-sm {% if isStopped %}text-green-600 font-medium{% elseif isPassed %}text-blue-600 font-medium{% else %}hidden{% endif %}">
										{% if isStopped %}Â· âœ… VisitÃ©{% elseif isPassed %}Â· ğŸš¶ PassÃ©{% endif %}
									</span>
								{% elseif isFork %}
									<span class="text-xs text-orange-600 font-semibold">âš ï¸ Fourche</span>
								{% else %}
									<span data-station-target="statusText" class="text-xs sm:text-sm {% if isStopped %}text-green-600 font-medium{% elseif isPassed %}text-blue-600 font-medium{% else %}text-gray-400{% endif %}">
										{% if isStopped %}âœ… VisitÃ©{% elseif isPassed %}ğŸš¶ PassÃ©{% else %}Touchez le cercle{% endif %}
									</span>
								{% endif %}
								{% if station.branch == 'direction' %}
									{% if line.number == '7bis' %}
										<span class="hidden sm:inline text-xs text-blue-600">â†’ PrÃ©-Saint-Gervais</span>
									{% elseif line.number == '10' %}
										<span class="hidden sm:inline text-xs text-blue-600">â†’ Gare d'Austerlitz</span>
									{% endif %}
								{% endif %}
								{% if station.branch == 'retour' %}
									{% if line.number == '7bis' %}
										<span class="hidden sm:inline text-xs text-purple-600">â†’ Louis Blanc</span>
									{% elseif line.number == '10' %}
										<span class="hidden sm:inline text-xs text-purple-600">â†’ Boulogne</span>
									{% endif %}
								{% endif %}
							</div>
						</div>

						{# Indicateur visuel sur mobile #}
						<div class="sm:hidden text-xl shrink-0" data-station-target="mobileIcon">
							{% if isStopped %}
								âœ…
							{% elseif isPassed %}
								ğŸš¶
							{% else %}
								â—‹
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	{% endmacro %}
{% endblock %}
