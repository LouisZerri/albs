{% extends 'base.html.twig' %}

{% block title %}Nouvelle discussion - Ligne
	{{ line.number }}
	- Ã€ la bonne station
{% endblock %}

{% block body %}
	<div
		class="max-w-5xl mx-auto px-4 py-8" data-controller="image-uploader">
		{# Breadcrumb #}
		<div class="mb-6">
			<nav class="flex items-center text-sm text-gray-600">
				<a href="{{ path('app_forum') }}" class="hover:text-blue-600">Forum</a>
				<span class="mx-2">/</span>
				<a href="{{ path('app_forum_line', {lineNumber: line.number}) }}" class="hover:text-blue-600">Ligne
					{{ line.number }}</a>
				<span class="mx-2">/</span>
				<span class="text-gray-900 font-medium">Nouvelle discussion</span>
			</nav>
		</div>

		{# En-tÃªte #}
		<div class="bg-white rounded-xl shadow-lg p-8 mb-8">
			<div class="flex items-center space-x-6">
				<div class="inline-flex items-center justify-center w-24 h-24 rounded-full text-white font-bold text-5xl" style="background-color: {{ line.color }}; color: {{ line.textColor }};">
					{% if 'bis' in line.number %}
						{{ line.number|replace({'bis': ''}) }}<span class="text-2xl">bis</span>
					{% else %}
						{{ line.number }}
					{% endif %}
				</div>
				<div>
					<h1 class="text-4xl font-bold text-gray-900 mb-2">Nouvelle discussion</h1>
					<p class="text-xl text-gray-600">Sur la ligne
						{{ line.number }}
						-
						{{ line.name }}</p>
				</div>
			</div>
		</div>

		{# Formulaire #}
		<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
			<div class="p-8">
				<div x-data="{
					submitOnEnter(event) {
						if (event.key === 'Enter' && !event.shiftKey) {
							event.preventDefault();
							// Synchroniser les fichiers avant soumission
							const imageInput = document.getElementById('image-input');
							if (window.imageFiles && window.imageFiles.length > 0) {
								const dataTransfer = new DataTransfer();
								window.imageFiles.forEach(f => dataTransfer.items.add(f));
								imageInput.files = dataTransfer.files;
							}
							event.target.form.submit();
						}
					}
				}">
					{{ form_start(form, {'attr': {'class': 'space-y-6', 'enctype': 'multipart/form-data'}}) }}

					<div>
						{{ form_row(form.title) }}
					</div>

					<div>
						{{ form_label(form.content) }}
						{{ form_widget(form.content, {
                        'attr': {
                            'x-on:keydown': 'submitOnEnter($event)',
                            'placeholder': 'Ã‰crivez votre message... (EntrÃ©e pour envoyer, Shift+EntrÃ©e pour un saut de ligne)'
                        }
                    }) }}
						<p class="text-xs text-gray-500 mt-1">
							ğŸ’¡ Appuyez sur
							<kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs font-mono">EntrÃ©e</kbd>
							pour crÃ©er,
							<kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs font-mono">Shift + EntrÃ©e</kbd>
							pour un saut de ligne
						</p>
					</div>

					{# Upload d'images avec accumulation #}
					<div class="border-2 border-dashed border-gray-300 rounded-lg p-4"
						data-image-uploader-target="dropzone"
						data-action="drop->image-uploader#handleDrop dragover->image-uploader#dragOver dragleave->image-uploader#dragLeave">
						
						<input type="file" 
							id="reply-image-input"
							name="images[]" 
							multiple 
							accept="image/*"
							class="hidden"
							data-image-uploader-target="input"
							data-action="change->image-uploader#handleFiles">
						
						<label for="reply-image-input" class="cursor-pointer text-center block">
							<span class="text-gray-500">ğŸ“· Glissez vos images ici ou cliquez pour sÃ©lectionner</span>
							<span class="text-xs text-gray-400 block mt-1">Max 3 images, 5 Mo chacune</span>
						</label>
						
						<div data-image-uploader-target="previews" class="flex gap-2 mt-3 flex-wrap"></div>
					</div>

					<div class="bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 p-6 rounded-r-xl" style="border-color: #3b82f6;">
						<p class="text-blue-900 font-medium">
							ğŸ“œ En publiant, vous acceptez les
							<a href="{{ path('app_forum_rules') }}" target="_blank" class="underline hover:text-blue-700">rÃ¨gles du forum</a>. 
								        Soyez respectueux et constructif !
						</p>
					</div>

					<div class="flex items-center justify-between pt-6">
						<a href="{{ path('app_forum_line', {lineNumber: line.number}) }}" class="text-gray-600 hover:text-gray-900 font-medium text-lg">
							â† Retour
						</a>
						<button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-10 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl text-lg cursor-pointer">
							CrÃ©er la discussion
						</button>
					</div>

					{{ form_end(form) }}
				</div>
			</div>
		</div>
	</div>
{% endblock %}
