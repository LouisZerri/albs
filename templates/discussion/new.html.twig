{% extends 'base.html.twig' %}

{% block title %}Nouvelle discussion - Ligne
	{{ line.number }}
	- Ã€ la bonne station
{% endblock %}

{% block body %}
	<div
		class="max-w-5xl mx-auto px-4 py-8">
		{# Breadcrumb #}
		<div class="mb-6">
			<nav class="flex items-center text-sm text-gray-600">
				<a href="{{ path('app_forum') }}" class="hover:text-blue-600">Forum</a>
				<span class="mx-2">/</span>
				<a href="{{ path('app_forum_line', {lineNumber: line.number}) }}" class="hover:text-blue-600">Ligne
					{{ line.number }}</a>
				<span class="mx-2">/</span>
				<span class="text-gray-900 font-medium">Nouvelle discussion</span>
			</nav>
		</div>

		{# En-tÃªte #}
		<div class="bg-white rounded-xl shadow-lg p-8 mb-8">
			<div class="flex items-center space-x-6">
				<div class="inline-flex items-center justify-center w-24 h-24 rounded-full text-white font-bold text-5xl" style="background-color: {{ line.color }}; color: {{ line.textColor }};">
					{% if 'bis' in line.number %}
						{{ line.number|replace({'bis': ''}) }}<span class="text-2xl">bis</span>
					{% else %}
						{{ line.number }}
					{% endif %}
				</div>
				<div>
					<h1 class="text-4xl font-bold text-gray-900 mb-2">Nouvelle discussion</h1>
					<p class="text-xl text-gray-600">Sur la ligne
						{{ line.number }}
						-
						{{ line.name }}</p>
				</div>
			</div>
		</div>

		{# Formulaire #}
		<div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
			<div class="p-8">
				<div x-data="{
						                submitOnEnter(event) {
						                    if (event.key === 'Enter' && !event.shiftKey) {
						                        event.preventDefault();
						                        // Synchroniser les fichiers avant soumission
						                        const imageInput = document.getElementById('image-input');
						                        if (window.imageFiles && window.imageFiles.length > 0) {
						                            const dataTransfer = new DataTransfer();
						                            window.imageFiles.forEach(f => dataTransfer.items.add(f));
						                            imageInput.files = dataTransfer.files;
						                        }
						                        event.target.form.submit();
						                    }
						                }
						            }">
					{{ form_start(form, {'attr': {'class': 'space-y-6', 'enctype': 'multipart/form-data'}}) }}

					<div>
						{{ form_row(form.title) }}
					</div>

					<div>
						{{ form_label(form.content) }}
						{{ form_widget(form.content, {
                        'attr': {
                            'x-on:keydown': 'submitOnEnter($event)',
                            'placeholder': 'Ã‰crivez votre message... (EntrÃ©e pour envoyer, Shift+EntrÃ©e pour un saut de ligne)'
                        }
                    }) }}
						<p class="text-xs text-gray-500 mt-1">
							ğŸ’¡ Appuyez sur
							<kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs font-mono">EntrÃ©e</kbd>
							pour crÃ©er,
							<kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs font-mono">Shift + EntrÃ©e</kbd>
							pour un saut de ligne
						</p>
					</div>

					{# Upload d'images avec accumulation #}
					<div x-data="{
							                    previews: [],
							                    files: [],
							                    init() {
							                        window.imageFiles = this.files;
							                    },
							                    handleFiles(event) {
							                        const newFiles = Array.from(event.target.files);
							
							                        for (let file of newFiles) {
							                            if (this.files.length >= 3) break;
							                            if (!file.type.startsWith('image/')) continue;
							                            if (file.size > 5 * 1024 * 1024) {
							                                alert('Image trop volumineuse (max 5 Mo)');
							                                continue;
							                            }
							
							                            if (this.files.some(f => f.name === file.name && f.size === file.size)) continue;
							
							                            this.files.push(file);
							
							                            const reader = new FileReader();
							                            reader.onload = (e) => {
							                                this.previews.push({
							                                    url: e.target.result,
							                                    name: file.name
							                                });
							                            };
							                            reader.readAsDataURL(file);
							                        }
							
							                        this.updateInput();
							                        window.imageFiles = this.files;
							                    },
							                    removeImage(index) {
							                        this.previews.splice(index, 1);
							                        this.files.splice(index, 1);
							                        this.updateInput();
							                        window.imageFiles = this.files;
							                    },
							                    updateInput() {
							                        const input = document.getElementById('image-input');
							                        const dataTransfer = new DataTransfer();
							                        this.files.forEach(f => dataTransfer.items.add(f));
							                        input.files = dataTransfer.files;
							                    }
							                }">
						<label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“· Images (optionnel, max 3)</label>

						<div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-500 transition-colors">
							<input type="file" name="images[]" multiple accept="image/jpeg,image/png,image/gif,image/webp" class="hidden" id="image-input" @change="handleFiles($event)">

							<div x-show="previews.length === 0">
								<span class="text-4xl">ğŸ“·</span>
								<p class="mt-2 text-gray-600">
									<label for="image-input" class="text-blue-600 hover:text-blue-800 cursor-pointer font-medium">
										Cliquez pour ajouter des images
									</label>
								</p>
								<p class="text-xs text-gray-400 mt-1">JPG, PNG, GIF, WebP â€¢ Max 5 Mo par image</p>
							</div>

							<div x-show="previews.length > 0" class="grid grid-cols-3 gap-4">
								<template x-for="(preview, index) in previews" :key="index">
									<div class="relative group">
										<img :src="preview.url" class="w-full h-32 object-cover rounded-lg">
										<button type="button" @click="removeImage(index)" class="absolute top-2 right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
											Ã—
										</button>
										<p class="text-xs text-gray-500 mt-1 truncate" x-text="preview.name"></p>
									</div>
								</template>

								<label x-show="previews.length < 3" for="image-input" class="h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-blue-500 transition-colors">
									<span class="text-3xl text-gray-400">+</span>
								</label>
							</div>
						</div>
					</div>

					<div class="bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 p-6 rounded-r-xl" style="border-color: #3b82f6;">
						<p class="text-blue-900 font-medium">
							ğŸ“œ En publiant, vous acceptez les
							<a href="{{ path('app_forum_rules') }}" target="_blank" class="underline hover:text-blue-700">rÃ¨gles du forum</a>. 
								        Soyez respectueux et constructif !
						</p>
					</div>

					<div class="flex items-center justify-between pt-6">
						<a href="{{ path('app_forum_line', {lineNumber: line.number}) }}" class="text-gray-600 hover:text-gray-900 font-medium text-lg">
							â† Retour
						</a>
						<button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-10 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl text-lg cursor-pointer">
							CrÃ©er la discussion
						</button>
					</div>

					{{ form_end(form) }}
				</div>
			</div>
		</div>
	</div>
{% endblock %}
