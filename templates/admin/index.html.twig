{% extends 'base.html.twig' %}

{% block main_class %}max-w-screen-2xl mx-auto px-6 lg:px-10
{% endblock %}

{% block title %}Administration - Ã€ la bonne station
{% endblock %}

{% block body %}
	<div
		x-data="{ activeTab: 'stats', searchQuery: '', searchResults: [], searching: false }">

		{# En-tÃªte #}
		<div class="bg-gradient-to-r from-gray-800 via-gray-900 to-black rounded-3xl shadow-2xl p-8 mb-8 text-white">
			<div class="flex items-center justify-between">
				<div>
					<h1 class="text-4xl font-black flex items-center gap-3">
						<span>âš™ï¸</span>
						<span>Administration</span>
					</h1>
					<p class="text-gray-400 mt-2">GÃ©rez votre application</p>
				</div>
				<div class="text-6xl">ğŸ› ï¸</div>
			</div>
		</div>

		{# Navigation par onglets #}
		<div class="bg-white rounded-2xl shadow-lg mb-8 border border-gray-100">
			<div class="flex border-b border-gray-200">
				<button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'" class="flex-1 px-6 py-4 text-sm font-semibold border-b-2 transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
					<span>ğŸ“Š</span>
					<span>Statistiques</span>
				</button>
				<button @click="activeTab = 'users'" :class="activeTab === 'users' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'" class="flex-1 px-6 py-4 text-sm font-semibold border-b-2 transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
					<span>ğŸ‘¥</span>
					<span>Utilisateurs</span>
				</button>
				<button @click="activeTab = 'logs'" :class="activeTab === 'logs' ? 'border-orange-500 text-orange-600 bg-orange-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'" class="flex-1 px-6 py-4 text-sm font-semibold border-b-2 transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
					<span>ğŸ“</span>
					<span>Logs d'activitÃ©</span>
				</button>
			</div>
		</div>

		{# ===== ONGLET STATISTIQUES ===== #}
		<div
			x-show="activeTab === 'stats'" x-transition>

			{# Stats globales #}
			<div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
				<div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 border border-blue-200">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-blue-600 text-sm font-medium">Total utilisateurs</p>
							<p class="text-4xl font-black text-blue-700 mt-1">{{ totalUsers }}</p>
						</div>
						<span class="text-4xl">ğŸ‘¥</span>
					</div>
				</div>

				<div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6 border border-green-200">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-green-600 text-sm font-medium">Nouveaux (7j)</p>
							<p class="text-4xl font-black text-green-700 mt-1">{{ newUsersWeek }}</p>
						</div>
						<span class="text-4xl">ğŸ†•</span>
					</div>
				</div>

				<div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6 border border-purple-200">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-purple-600 text-sm font-medium">Utilisateurs actifs</p>
							<p class="text-4xl font-black text-purple-700 mt-1">{{ activeUsers }}</p>
						</div>
						<span class="text-4xl">âœ…</span>
					</div>
				</div>

				<div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl p-6 border border-orange-200">
					<div class="flex items-center justify-between">
						<div>
							<p class="text-orange-600 text-sm font-medium">Discussions / RÃ©ponses</p>
							<p class="text-4xl font-black text-orange-700 mt-1">{{ totalDiscussions }}
								<span class="text-2xl text-orange-400">/</span>
								{{ totalReplies }}</p>
						</div>
						<span class="text-4xl">ğŸ’¬</span>
					</div>
				</div>
			</div>

			{# Stations et badges populaires #}
			<div
				class="grid lg:grid-cols-2 gap-8">
				{# Top stations #}
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
						<h2 class="text-xl font-bold text-white flex items-center gap-2">
							<span>ğŸš‡</span>
							<span>Stations les plus visitÃ©es</span>
						</h2>
					</div>
					<div class="p-6">
						{% if topStations|length > 0 %}
							<div class="space-y-3">
								{% for station in topStations %}
									<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
										<div class="flex items-center gap-3">
											<span class="text-lg font-bold text-gray-400">#{{ loop.index }}</span>
											<div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold" style="background-color: {{ station.lineColor }};">
												{{ station.lineNumber }}
											</div>
											<span class="font-medium text-gray-900">{{ station.name }}</span>
										</div>
										<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-bold">
											{{ station.visitCount }}
											visites
										</span>
									</div>
								{% endfor %}
							</div>
						{% else %}
							<p class="text-gray-500 text-center py-8">Aucune donnÃ©e disponible</p>
						{% endif %}
					</div>
				</div>

				{# Top badges #}
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-yellow-500 to-orange-500 px-6 py-4">
						<h2 class="text-xl font-bold text-white flex items-center gap-2">
							<span>ğŸ†</span>
							<span>Badges les plus dÃ©bloquÃ©s</span>
						</h2>
					</div>
					<div class="p-6">
						{% if topBadges|length > 0 %}
							<div class="space-y-3">
								{% for badge in topBadges %}
									<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
										<div class="flex items-center gap-3">
											<span class="text-lg font-bold text-gray-400">#{{ loop.index }}</span>
											<span class="text-2xl">{{ badge.icon }}</span>
											<span class="font-medium text-gray-900">{{ badge.name }}</span>
										</div>
										<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold">
											{{ badge.unlockCount }}
											users
										</span>
									</div>
								{% endfor %}
							</div>
						{% else %}
							<p class="text-gray-500 text-center py-8">Aucune donnÃ©e disponible</p>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		{# ===== ONGLET UTILISATEURS ===== #}
		<div
			x-show="activeTab === 'users'" x-transition>

			{# Recherche utilisateur #}
			<div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
				<h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
					<span>ğŸ”</span>
					<span>Rechercher un utilisateur</span>
				</h2>
				<div class="relative">
					<input type="text" x-model="searchQuery" @input.debounce.300ms="
						                            if (searchQuery.length >= 2) {
						                                searching = true;
						                                fetch('/admin/search?q=' + encodeURIComponent(searchQuery))
						                                    .then(r => r.json())
						                                    .then(data => { searchResults = data.users; searching = false; })
						                                    .catch(() => { searching = false; });
						                            } else {
						                                searchResults = [];
						                            }
						                        " placeholder="Rechercher par nom d'utilisateur ou email..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
					<div x-show="searching" class="absolute right-4 top-1/2 -translate-y-1/2">
						<svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24">
							<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
							<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
						</svg>
					</div>
				</div>

				{# RÃ©sultats de recherche #}
				<div x-show="searchResults.length > 0" class="mt-4 space-y-2">
					<template x-for="user in searchResults" :key="user.id">
						<div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
							<div class="flex items-center gap-4">
								<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-600 flex items-center justify-center text-white font-bold" x-text="user.username.charAt(0).toUpperCase()"></div>
								<div>
									<a :href="user.profileUrl" class="font-bold text-gray-900 hover:text-blue-600" x-text="user.username"></a>
									<p class="text-sm text-gray-500" x-text="user.email"></p>
								</div>
								<span x-show="user.isAdmin" class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-bold">Admin</span>
								<span x-show="user.isModerator && !user.isAdmin" class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-bold">Modo</span>
								<span x-show="user.accountStatus === 'banned'" class="px-2 py-1 bg-gray-800 text-white text-xs rounded-full font-bold">Banni</span>
							</div>
							<a :href="user.profileUrl" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors">
								Voir profil â†’
							</a>
						</div>
					</template>
				</div>
				<p x-show="searchQuery.length >= 2 && searchResults.length === 0 && !searching" class="mt-4 text-gray-500 text-center">
					Aucun utilisateur trouvÃ©
				</p>
			</div>

			<div
				class="grid lg:grid-cols-2 gap-8">
				{# Derniers inscrits #}
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-4">
						<h2 class="text-xl font-bold text-white flex items-center gap-2">
							<span>ğŸ†•</span>
							<span>Derniers inscrits</span>
						</h2>
					</div>
					<div class="p-6 max-h-96 overflow-y-auto scrollbar-thin">
						<div class="space-y-3">
							{% for user in latestUsers %}
								<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
									<div class="flex items-center gap-3">
										<div class="w-10 h-10 rounded-full overflow-hidden bg-gradient-to-br from-blue-400 to-purple-600 flex items-center justify-center">
											{% if user.avatarUrl %}
												<img src="{{ asset('uploads/avatars/' ~ user.avatarUrl) }}" class="w-full h-full object-cover">
											{% else %}
												<span class="text-white font-bold">{{ user.username|first|upper }}</span>
											{% endif %}
										</div>
										<div>
											<a href="{{ path('app_profile_public', {username: user.username}) }}" class="font-medium text-gray-900 hover:text-blue-600">
												{{ user.username }}
											</a>
											<p class="text-xs text-gray-500">{{ user.createdAt|date('d/m/Y H:i') }}</p>
										</div>
									</div>
									<div
										class="flex items-center gap-2">
										{# Statut #}
										{% if user.accountStatus == 'pending' %}
											<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">En attente</span>
										{% elseif user.accountStatus == 'banned' %}
											<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">Banni</span>
										{% else %}
											<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Actif</span>
										{% endif %}

										{# RÃ´le actuel #}
										{% if user.isAdmin %}
											<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-bold">Admin</span>
										{% elseif user.isModerator %}
											<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-bold">Modo</span>
										{% endif %}

										{# Bouton promouvoir/rÃ©trograder (sauf pour admin) #}
										{% if not user.isAdmin %}
											<form method="post" action="{{ path('app_admin_promote', {id: user.id}) }}" onsubmit="return confirm('{{ user.isModerator ? 'RÃ©trograder' : 'Promouvoir' }} {{ user.username }} ?')">
												<input type="hidden" name="_token" value="{{ csrf_token('promote_' ~ user.id) }}">
												{% if user.isModerator %}
													<button type="submit" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 text-xs rounded-lg transition-colors cursor-pointer">
														â†“ RÃ©trograder
													</button>
												{% else %}
													<button type="submit" class="px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs rounded-lg transition-colors cursor-pointer">
														â†‘ Promouvoir modo
													</button>
												{% endif %}
											</form>
										{% endif %}
									</div>
								</div>
							{% endfor %}
						</div>
					</div>
				</div>
				{# ModÃ©rateurs #}
				<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
					<div class="bg-gradient-to-r from-purple-500 to-violet-600 px-6 py-4">
						<h2 class="text-xl font-bold text-white flex items-center gap-2">
							<span>ğŸ›¡ï¸</span>
							<span>ModÃ©rateurs</span>
						</h2>
					</div>
					<div class="p-6">
						{% if moderators|length > 0 %}
							<div class="space-y-3">
								{% for modo in moderators %}
									<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
										<div class="flex items-center gap-3">
											<div class="w-10 h-10 rounded-full overflow-hidden bg-gradient-to-br from-purple-400 to-violet-600 flex items-center justify-center">
												{% if modo.avatarUrl %}
													<img src="{{ asset('uploads/avatars/' ~ modo.avatarUrl) }}" class="w-full h-full object-cover">
												{% else %}
													<span class="text-white font-bold">{{ modo.username|first|upper }}</span>
												{% endif %}
											</div>
											<a href="{{ path('app_profile_public', {username: modo.username}) }}" class="font-medium text-gray-900 hover:text-blue-600">
												{{ modo.username }}
											</a>
										</div>
										<form method="post" action="{{ path('app_admin_promote', {id: modo.id}) }}" onsubmit="return confirm('RÃ©trograder {{ modo.username }} ?')">
											<input type="hidden" name="_token" value="{{ csrf_token('promote_' ~ modo.id) }}">
											<button type="submit" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 text-sm rounded-lg transition-colors cursor-pointer">
												RÃ©trograder
											</button>
										</form>
									</div>
								{% endfor %}
							</div>
						{% else %}
							<p class="text-gray-500 text-center py-8">Aucun modÃ©rateur</p>
						{% endif %}
					</div>
				</div>
			</div>

			{# Utilisateurs bannis #}
			<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mt-8">
				<div class="bg-gradient-to-r from-red-500 to-red-600 px-6 py-4">
					<h2 class="text-xl font-bold text-white flex items-center gap-2">
						<span>ğŸš«</span>
						<span>Utilisateurs bannis</span>
						<span class="px-2 py-1 bg-white/20 rounded-full text-sm">{{ bannedUsers|length }}</span>
					</h2>
				</div>
				<div class="p-6">
					{% if bannedUsers|length > 0 %}
						<div class="max-h-64 overflow-y-auto scrollbar-thin space-y-3">
							{% for user in bannedUsers %}
								<div class="flex items-center justify-between p-4 bg-red-50 rounded-xl border border-red-100">
									<div class="flex items-center gap-4">
										<div class="w-10 h-10 rounded-full overflow-hidden bg-gray-400 flex items-center justify-center">
											{% if user.avatarUrl %}
												<img src="{{ asset('uploads/avatars/' ~ user.avatarUrl) }}" class="w-full h-full object-cover grayscale">
											{% else %}
												<span class="text-white font-bold">{{ user.username|first|upper }}</span>
											{% endif %}
										</div>
										<div>
											<span class="font-medium text-gray-900">{{ user.username }}</span>
											<p class="text-xs text-gray-500">Banni le
												{{ user.bannedAt|date('d/m/Y Ã  H:i') }}</p>
										</div>
									</div>
									<form method="post" action="{{ path('app_admin_unban', {id: user.id}) }}" onsubmit="return confirm('DÃ©bannir {{ user.username }} ?')">
										<input type="hidden" name="_token" value="{{ csrf_token('unban_' ~ user.id) }}">
										<button type="submit" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded-lg transition-colors cursor-pointer">
											âœ“ DÃ©bannir
										</button>
									</form>
								</div>
							{% endfor %}
						</div>
					{% else %}
						<p class="text-gray-500 text-center py-8">ğŸ‰ Aucun utilisateur banni</p>
					{% endif %}
				</div>
			</div>
		</div>

		{# ===== ONGLET LOGS ===== #}
		<div x-show="activeTab === 'logs'" x-transition>
			<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
				<div class="bg-gradient-to-r from-orange-500 to-amber-600 px-6 py-4">
					<h2 class="text-xl font-bold text-white flex items-center gap-2">
						<span>ğŸ“</span>
						<span>Historique des actions de modÃ©ration</span>
					</h2>
				</div>
				<div class="p-6">
					{% if latestWarnings|length > 0 %}
						<div class="max-h-[600px] overflow-y-auto scrollbar-thin space-y-4">
							{% for warning in latestWarnings %}
								<div class="p-4 rounded-xl border-l-4
									{% if warning.relatedPostType == 'direct_ban' %}
										bg-red-50 border-red-500
									{% else %}
										bg-orange-50 border-orange-500
									{% endif %}">
									<div class="flex items-start justify-between">
										<div class="flex-grow">
											<div class="flex items-center gap-3 mb-2">
												{% if warning.relatedPostType == 'direct_ban' %}
													<span class="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded">BAN</span>
												{% else %}
													<span class="px-2 py-1 bg-orange-500 text-white text-xs font-bold rounded">WARN</span>
												{% endif %}
												<span class="text-gray-500 text-sm">{{ warning.createdAt|date('d/m/Y Ã  H:i') }}</span>
											</div>

											<p class="text-gray-800 mb-2">
												<a href="{{ path('app_profile_public', {username: warning.moderator.username}) }}" class="font-bold text-blue-600 hover:underline">
													{{ warning.moderator.username }}
												</a>
												{% if warning.relatedPostType == 'direct_ban' %}
													a banni
												{% else %}
													a averti
												{% endif %}
												<a href="{{ path('app_profile_public', {username: warning.user.username}) }}" class="font-bold text-purple-600 hover:underline">
													{{ warning.user.username }}
												</a>
											</p>

											<p class="text-sm text-gray-600 bg-white p-3 rounded-lg border border-gray-200">
												{{ warning.reason }}
											</p>
										</div>

										{% if warning.acknowledgedAt %}
											<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full ml-4">
												âœ“ Lu
											</span>
										{% else %}
											<span class="px-2 py-1 bg-gray-200 text-gray-600 text-xs rounded-full ml-4">
												Non lu
											</span>
										{% endif %}
									</div>
								</div>
							{% endfor %}
						</div>
					{% else %}
						<div class="text-center py-12">
							<span class="text-6xl">ğŸ“‹</span>
							<p class="text-gray-500 mt-4">Aucune action de modÃ©ration enregistrÃ©e</p>
						</div>
					{% endif %}
				</div>
			</div>
		</div>

	</div>
{% endblock %}
