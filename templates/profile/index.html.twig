{% extends 'base.html.twig' %}

{% block main_class %}max-w-screen-3xl mx-auto px-6 lg:px-10{% endblock %}

{% block title %}Mon profil - Ã€ la bonne station {% endblock %}

{% block body %}
	<div class="max-w-screen-2xl mx-auto px-6 lg:px-10">

		{# Alerte avertissements NON LUS uniquement #}
		{% set unreadWarnings = user.warnings|filter(w => w.acknowledgedAt is null) %}
		{% if not user.isBanned and unreadWarnings|length > 0 %}
			<div class="mb-6 bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl p-6 shadow-lg">
				<div class="flex items-center">
					<div class="flex-shrink-0">
						<span class="text-5xl animate-bounce">âš ï¸</span>
					</div>
					<div class="ml-4 flex-grow text-white">
						<h3 class="text-xl font-bold">
							{{ unreadWarnings|length }}
							nouvel avertissement{{ unreadWarnings|length > 1 ? 's' : '' }}
							!
						</h3>
						<p class="mt-1 text-orange-100">
							{% if user.warningCount == 2 %}
								âš ï¸ Dernier avertissement avant bannissement !
							{% else %}
								Vous avez
								{{ user.warningCount }}/3 avertissement{{ user.warningCount > 1 ? 's' : '' }}.
							{% endif %}
						</p>
					</div>
					<button onclick="document.getElementById('tab-warnings').click()" class="px-5 py-3 bg-white text-orange-600 font-bold rounded-xl hover:bg-orange-50 transition-colors cursor-pointer">
						Voir â†’
					</button>
				</div>
			</div>
		{% endif %}

		{# Layout principal : Sidebar + Contenu #}
		<div
			class="flex flex-col lg:flex-row gap-8">

			{# ===== SIDEBAR ===== #}
			<div class="lg:w-96 flex-shrink-0">
				<div
					class="lg:sticky lg:top-8 space-y-6">

					{# Carte profil #}
					<div class="bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-700 rounded-3xl shadow-2xl p-8 text-white relative overflow-hidden">
						{# Cercles dÃ©coratifs #}
						<div class="absolute top-0 right-0 size-32 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
						<div class="absolute bottom-0 left-0 size-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>

						<div
							class="relative">
							{# Avatar #}
							<div class="flex justify-center mb-4">
								<div class="size-32 rounded-full overflow-hidden bg-white/20 backdrop-blur-sm flex items-center justify-center ring-4 ring-white/30 shadow-xl">
									{% if user.avatarUrl %}
										<img src="{{ asset('uploads/avatars/' ~ user.avatarUrl) }}" alt="{{ user.username }}" class="size-full object-cover">
									{% else %}
										<span class="text-7xl">ğŸ‘¤</span>
									{% endif %}
								</div>
							</div>

							{# Username + Rang #}
							<div class="text-center">
								<h1 class="text-3xl font-black tracking-tight">{{ user.username }}</h1>

								<div
									class="flex justify-center gap-2 mt-3 flex-wrap">
									{# Rang #}
									{% set totalStations = totalPassed + totalStopped %}
									{% if totalStations >= 500 %}
										<span class="px-3 py-1 bg-yellow-400 text-yellow-900 rounded-full text-xs font-bold">ğŸ… Expert</span>
									{% elseif totalStations >= 200 %}
										<span class="px-3 py-1 bg-purple-400 text-purple-900 rounded-full text-xs font-bold">ğŸ¯ Voyageur</span>
									{% elseif totalStations >= 50 %}
										<span class="px-3 py-1 bg-blue-400 text-blue-900 rounded-full text-xs font-bold">ğŸš‡ Explorateur</span>
									{% else %}
										<span class="px-3 py-1 bg-green-400 text-green-900 rounded-full text-xs font-bold">ğŸŒ± DÃ©butant</span>
									{% endif %}

									{# Badge CrÃ©ateur #}
									{% if user.isAdmin %}
										<span class="px-3 py-1 text-white rounded-full text-xs font-bold shadow-lg badge-gold">
											ğŸ‘‘ CrÃ©ateur
										</span>
									{% endif %}
								</div>

								{# Badges affichÃ©s #}
								{% set displayedBadgeIds = user.displayedBadges %}
								{% set displayedBadges = badgesStatus|filter(b => b.unlocked and b.badge.id in displayedBadgeIds) %}
								{% if displayedBadges|length > 0 %}
									<div class="flex justify-center gap-1 mt-3">
										{% for badgeStatus in displayedBadges %}
											<span class="text-2xl hover:scale-125 transition-transform cursor-help" title="{{ badgeStatus.badge.name }}">
												{{ badgeStatus.badge.icon }}
											</span>
										{% endfor %}
									</div>
								{% endif %}

								<p class="text-blue-200 text-sm mt-3">{{ user.email }}</p>
								<p class="text-xs text-blue-300 mt-1">
									ğŸ“… Membre depuis le
									{{ user.createdAt|date('d/m/Y') }}
								</p>
							</div>
						</div>
					</div>

					{# Stats rapides #}
					<div class="bg-white rounded-2xl shadow-lg p-5 border border-gray-100">
						<h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4">ğŸ“Š Statistiques</h3>

						<div class="space-y-4">
							<div>
								<div class="flex justify-between text-sm mb-1">
									<span class="text-gray-600">ğŸš¶ Stations passÃ©es</span>
									<span class="font-bold text-blue-600">{{ totalPassed }}/309</span>
								</div>
								<div class="bg-blue-100 rounded-full h-2">
									<div class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: {{ (totalPassed / 309 * 100)|round }}%"></div>
								</div>
							</div>

							<div>
								<div class="flex justify-between text-sm mb-1">
									<span class="text-gray-600">âœ… Stations visitÃ©es</span>
									<span class="font-bold text-green-600">{{ totalStopped }}/309</span>
								</div>
								<div class="bg-green-100 rounded-full h-2">
									<div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: {{ (totalStopped / 309 * 100)|round }}%"></div>
								</div>
							</div>

							<div>
								<div class="flex justify-between text-sm mb-1">
									<span class="text-gray-600">ğŸ† Badges</span>
									<span class="font-bold text-purple-600">{{ badgesStatus|filter(b => b.unlocked)|length }}/{{ badgesStatus|length }}</span>
								</div>
								<div class="bg-purple-100 rounded-full h-2">
									<div class="bg-purple-500 h-2 rounded-full transition-all duration-500" style="width: {{ (badgesStatus|filter(b => b.unlocked)|length / badgesStatus|length * 100)|round }}%"></div>
								</div>
							</div>
						</div>
					</div>

					{# Bouton modifier #}
					<a href="{{ path('app_profile_edit') }}" class="flex items-center justify-center gap-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold px-6 py-3 rounded-xl transition-all duration-300">
						<span>âœï¸</span>
						<span>Modifier le profil</span>
					</a>
				</div>
			</div>
			{# ===== CONTENU PRINCIPAL ===== #}
			<div class="flex-grow min-w-0">
				<div
					x-data="{ activeTab: 'badges' }" class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">

					{# Navigation par onglets #}
					<div class="flex border-b border-gray-200 bg-gray-50">
						<button @click="activeTab = 'badges'" id="tab-badges" :class="activeTab === 'badges' ? 'border-yellow-500 text-yellow-600 bg-white' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'" class="flex-1 px-4 py-4 text-sm font-semibold border-b-2 transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
							<span>ğŸ†</span>
							<span class="hidden sm:inline">Badges</span>
							<span class="px-2 py-0.5 rounded-full text-xs" :class="activeTab === 'badges' ? 'bg-yellow-500 text-white' : 'bg-gray-200 text-gray-600'">
								{{ badgesStatus|filter(b => b.unlocked)|length }}/{{ badgesStatus|length }}
							</span>
						</button>

						<button @click="activeTab = 'progression'" id="tab-progression" :class="activeTab === 'progression' ? 'border-blue-500 text-blue-600 bg-white' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'" class="flex-1 px-4 py-4 text-sm font-semibold border-b-2 transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
							<span>ğŸš‡</span>
							<span class="hidden sm:inline">Progression</span>
							<span class="px-2 py-0.5 rounded-full text-xs" :class="activeTab === 'progression' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'">
								{{ lineStats|length }}
							</span>
						</button>

						{% if user.warningCount > 0 %}
							<button @click="activeTab = 'warnings'" id="tab-warnings" :class="activeTab === 'warnings' ? 'border-orange-500 text-orange-600 bg-white' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'" class="flex-1 px-4 py-4 text-sm font-semibold border-b-2 transition-all duration-200 flex items-center justify-center gap-2 cursor-pointer">
								<span>âš ï¸</span>
								<span class="hidden sm:inline">Avertissements</span>
								<span class="px-2 py-0.5 rounded-full text-xs" :class="activeTab === 'warnings' ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-600'">
									{{ user.warningCount }}
								</span>
							</button>
						{% endif %}
					</div>

					{# Contenu des onglets #}
					<div
						class="p-8">

						{# ===== ONGLET BADGES ===== #}
						<div x-show="activeTab === 'badges'" x-transition>
							<div
								x-data="{ badgeSection: 'unlocked' }" class="space-y-4">

								{# Sous-navigation badges #}
								<div class="flex gap-2 mb-6">
									<button @click="badgeSection = 'unlocked'" :class="badgeSection === 'unlocked' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center gap-2">
										<span>âœ…</span>
										<span>DÃ©bloquÃ©s</span>
										<span class="px-1.5 py-0.5 rounded text-xs" :class="badgeSection === 'unlocked' ? 'bg-green-600' : 'bg-gray-300'">{{ badgesStatus|filter(b => b.unlocked)|length }}</span>
									</button>
									<button @click="badgeSection = 'locked'" :class="badgeSection === 'locked' ? 'bg-gray-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer flex items-center gap-2">
										<span>ğŸ”’</span>
										<span>Ã€ dÃ©bloquer</span>
										<span class="px-1.5 py-0.5 rounded text-xs" :class="badgeSection === 'locked' ? 'bg-gray-600' : 'bg-gray-300'">{{ badgesStatus|filter(b => not b.unlocked)|length }}</span>
									</button>
								</div>

								{# Badges dÃ©bloquÃ©s #}
								<div x-show="badgeSection === 'unlocked'" x-transition class="max-h-96 overflow-y-auto pr-2 scrollbar-thin">
									<div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-5">
										{% for badgeStatus in badgesStatus %}
											{% if badgeStatus.unlocked %}
												<div class="group rounded-2xl p-4 transition-all duration-300 hover:shadow-lg bg-gradient-to-br from-yellow-50 via-orange-50 to-amber-50 border-2 border-yellow-300 hover:border-yellow-400 flex flex-col" data-controller="badge-toggle" data-badge-toggle-badge-id-value="{{ badgeStatus.badge.id }}" data-badge-toggle-displayed-value="{{ badgeStatus.badge.id in user.displayedBadges ? 'true' : 'false' }}">

													<div class="flex items-start gap-3 mb-3 flex-grow">
														<div class="relative flex-shrink-0">
															<div class="text-4xl transition-transform duration-300 group-hover:scale-110">
																{{ badgeStatus.badge.icon }}
															</div>
															<div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
																<span class="text-white text-xs">âœ“</span>
															</div>
														</div>

														<div class="flex-grow min-w-0">
															<h3 class="font-bold text-gray-900">{{ badgeStatus.badge.name }}</h3>
															<p class="text-xs text-gray-600 leading-relaxed">{{ badgeStatus.badge.description }}</p>
														</div>
													</div>

													<button data-action="click->badge-toggle#toggle" class="w-full font-semibold text-xs py-2 px-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-1 cursor-pointer
                                                        {% if badgeStatus.badge.id in user.displayedBadges %}
                                                            bg-green-500 text-white hover:bg-green-600
                                                        {% else %}
                                                            bg-blue-500 text-white hover:bg-blue-600
                                                        {% endif %}">
														{% if badgeStatus.badge.id in user.displayedBadges %}
															<span>âœ“</span>
															<span>AffichÃ©</span>
														{% else %}
															<span>+</span>
															<span>Afficher</span>
														{% endif %}
													</button>
												</div>
											{% endif %}
										{% endfor %}
									</div>
								</div>

								{# Badges Ã  dÃ©bloquer #}
								<div x-show="badgeSection === 'locked'" x-transition class="max-h-[550px] overflow-y-auto pr-2 scrollbar-thin">
									<div class="grid sm:grid-cols-2 gap-4">
										{% for badgeStatus in badgesStatus %}
											{% if not badgeStatus.unlocked %}
												<div class="group rounded-2xl p-4 transition-all duration-300 hover:shadow-lg bg-gray-100 border-2 border-gray-200 hover:border-gray-300 flex flex-col">

													<div class="flex items-start gap-3 mb-3 flex-grow">
														<div class="text-4xl transition-transform duration-300 group-hover:scale-110 grayscale opacity-40">
															{{ badgeStatus.badge.icon }}
														</div>

														<div class="flex-grow min-w-0">
															<h3 class="font-bold text-gray-900">{{ badgeStatus.badge.name }}</h3>
															<p class="text-xs text-gray-600 leading-relaxed">{{ badgeStatus.badge.description }}</p>
														</div>
													</div>

													<div>
														<div class="flex justify-between text-xs mb-1">
															<span class="text-gray-500">Progression</span>
															<span class="font-bold text-gray-700">{{ badgeStatus.progress }}%</span>
														</div>
														<div class="bg-gray-300 rounded-full h-2 overflow-hidden">
															<div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full transition-all duration-1000" style="width: {{ badgeStatus.progress }}%"></div>
														</div>
													</div>
												</div>
											{% endif %}
										{% endfor %}
									</div>
								</div>
							</div>
						</div>
						{# ===== ONGLET PROGRESSION ===== #}
						<div x-show="activeTab === 'progression'" x-transition>
							{% if lineStats|length > 0 %}
								<div class="max-h-[550px] overflow-y-auto pr-2 scrollbar-thin space-y-3">
									{% for stat in lineStats %}
										<a href="{{ path('app_line_show', {id: stat.line.id}) }}" class="block p-4 rounded-xl border-2 border-gray-200 hover:border-gray-300 hover:shadow-md transition-all duration-200">
											<div
												class="flex items-center gap-4">
												{# Logo de la ligne #}
												<div class="relative flex-shrink-0">
													<div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-black shadow-lg" style="background: linear-gradient(135deg, {{ stat.line.color }}, {{ stat.line.color }}dd); color: {{ stat.line.textColor }};">
														{% if 'bis' in stat.line.number %}
															<div class="flex items-center">
																<span class="text-2xl leading-none">{{ stat.line.number|replace({'bis': ''}) }}</span>
																<span class="text-xs leading-none">bis</span>
															</div>
														{% else %}
															<span class="text-2xl">{{ stat.line.number }}</span>
														{% endif %}
													</div>
													{% if stat.stoppedPercentage == 100 %}
														<div class="absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center shadow-md">
															<span class="text-white text-xs">âœ“</span>
														</div>
													{% endif %}
												</div>

												{# Infos #}
												<div class="flex-grow min-w-0">
													<div class="flex items-center justify-between mb-2">
														<h3 class="font-bold text-gray-900">Ligne
															{{ stat.line.number }}</h3>
														<span class="text-sm font-bold" style="color: {{ stat.line.color }}">{{ stat.stoppedPercentage|round }}%</span>
													</div>

													<div class="bg-gray-200 rounded-full h-2 mb-2">
														<div class="h-2 rounded-full transition-all duration-500" style="width: {{ stat.stoppedPercentage }}%; background-color: {{ stat.line.color }};"></div>
													</div>

													<div class="flex gap-4 text-xs text-gray-500">
														<span>ğŸš¶
															{{ stat.passed }}/{{ stat.total }}</span>
														<span>âœ…
															{{ stat.stopped }}/{{ stat.total }}</span>
														{% if stat.stoppedPercentage == 100 %}
															<span class="text-green-600 font-bold">COMPLÃˆTE</span>
														{% endif %}
													</div>
												</div>

												{# FlÃ¨che #}
												<div class="text-gray-400 flex-shrink-0">
													<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
													</svg>
												</div>
											</div>
										</a>
									{% endfor %}
								</div>
							{% else %}
								<div class="text-center py-16">
									<div class="text-6xl mb-4">ğŸš‡</div>
									<h3 class="text-xl font-bold text-gray-800 mb-2">PrÃªt(e) pour l'aventure ?</h3>
									<p class="text-gray-600 mb-6">Tu n'as pas encore commencÃ© Ã  explorer le mÃ©tro parisien.</p>
									<a href="{{ path('app_lines') }}" class="inline-flex items-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold px-6 py-3 rounded-xl transition-all duration-300">
										<span>ğŸš€</span>
										<span>Commencer l'aventure</span>
									</a>
								</div>
							{% endif %}
						</div>

						{# ===== ONGLET AVERTISSEMENTS ===== #}
						{% if user.warningCount > 0 %}
							<div x-show="activeTab === 'warnings'" x-transition>
								<div class="max-h-96 overflow-y-auto pr-2 scrollbar-thin space-y-4">
									{% for warning in user.warnings|sort((a, b) => b.createdAt <=> a.createdAt) %}
										<div class="border-l-4 border-orange-500 bg-orange-50 rounded-r-xl p-4">
											<div class="flex items-start justify-between">
												<div class="flex-grow">
													<div class="flex items-center gap-2 mb-2">
														<span class="text-orange-600 font-bold">Avertissement #{{ loop.revindex }}</span>
														<span class="text-gray-400 text-sm">{{ warning.createdAt|date('d/m/Y Ã  H:i') }}</span>
														{% if not warning.acknowledgedAt %}
															<span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full font-semibold animate-pulse">
																Nouveau
															</span>
														{% endif %}
													</div>
													<p class="text-gray-700 text-sm">{{ warning.reason }}</p>
												</div>

												{% if not warning.acknowledgedAt %}
													<form method="post" action="{{ path('app_profile_acknowledge_warning', {id: warning.id}) }}" class="ml-4">
														<input type="hidden" name="_token" value="{{ csrf_token('acknowledge_warning') }}">
														<button type="submit" class="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white text-xs font-medium rounded-lg transition-colors cursor-pointer">
															âœ“ Lu
														</button>
													</form>
												{% else %}
													<span class="ml-4 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">
														âœ“ Lu
													</span>
												{% endif %}
											</div>
										</div>
									{% endfor %}
								</div>

								<div class="mt-4 p-4 bg-orange-100 border border-orange-300 rounded-xl">
									<p class="text-orange-800 text-sm">
										<strong>ğŸ“‹ Rappel :</strong>
										Au 3Ã¨me avertissement, votre compte sera automatiquement banni.
										<a href="{{ path('app_terms') }}" class="underline hover:text-orange-900">Voir les rÃ¨gles</a>
									</p>
								</div>
							</div>
						{% endif %}

					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
