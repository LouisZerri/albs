{% extends 'base.html.twig' %}

{% block title %}Modifier mon profil - √Ä la bonne station
{% endblock %}

{% block body %}
	<div
		class="max-w-4xl mx-auto px-4">
		{# Messages flash #}
		{% for message in app.flashes('success') %}
			<div class="mb-6 p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg">
				<p class="text-sm text-green-700">{{ message }}</p>
			</div>
		{% endfor %}

		{% for message in app.flashes('error') %}
			<div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
				<p class="text-sm text-red-700">{{ message }}</p>
			</div>
		{% endfor %}

		<div class="bg-white rounded-xl shadow-lg overflow-hidden">
			<div class="bg-gradient-to-r from-blue-500 to-purple-600 px-8 py-6">
				<div class="flex items-center justify-between">
					<div>
						<h1 class="text-3xl font-bold text-white">Modifier mon profil</h1>
						<p class="text-blue-100 mt-1">G√©rez vos informations personnelles</p>
					</div>
					<a href="{{ path('app_profile') }}" class="text-white hover:text-blue-100 text-sm font-medium">
						‚Üê Retour au profil
					</a>
				</div>
			</div>

			<div
				class="p-8">
				{# Photo de profil actuelle #}
				<div class="mb-8 pb-8 border-b border-gray-200">
					<h2 class="text-xl font-bold text-gray-900 mb-4">Photo de profil</h2>
					<div class="flex items-center space-x-6">
						<div class="w-24 h-24 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center">
							{% if user.avatarUrl %}
								<img src="{{ asset('uploads/avatars/' ~ user.avatarUrl) }}" alt="{{ user.username }}" class="w-full h-full object-cover">
							{% else %}
								<span class="text-5xl">üë§</span>
							{% endif %}
						</div>
						<div>
							{% if user.avatarUrl %}
								<form method="post" action="{{ path('app_profile_delete_avatar') }}" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer votre photo de profil ?');">
									<input type="hidden" name="_token" value="{{ csrf_token('delete-avatar') }}">
									<button type="submit" class="text-red-600 hover:text-red-800 text-sm font-medium cursor-pointer">
										üóëÔ∏è Supprimer la photo
									</button>
								</form>
							{% else %}
								<p class="text-sm text-gray-600">Aucune photo de profil</p>
							{% endif %}
						</div>
					</div>
				</div>

				{# Formulaire d'√©dition avec Alpine.js #}
				<div x-data="{
						                password: '',
						                passwordConfirm: '',
						                hasMinLength: false,
						                hasUppercase: false,
						                hasLowercase: false,
						                hasNumber: false,
						                hasSpecial: false,
						                passwordMatch: true,
						                isPasswordValid: true,
						                checkPassword() {
						                    if (this.password === '') {
						                        this.hasMinLength = false;
						                        this.hasUppercase = false;
						                        this.hasLowercase = false;
						                        this.hasNumber = false;
						                        this.hasSpecial = false;
						                        this.isPasswordValid = true;
						                        return;
						                    }
						                    this.hasMinLength = this.password.length >= 6;
						                    this.hasUppercase = /[A-Z]/.test(this.password);
						                    this.hasLowercase = /[a-z]/.test(this.password);
						                    this.hasNumber = /[0-9]/.test(this.password);
						                    this.hasSpecial = /[@$!%*?&_\-#]/.test(this.password);
						                    this.isPasswordValid = this.hasMinLength && this.hasUppercase && this.hasLowercase && this.hasNumber && this.hasSpecial;
						                },
						                checkPasswordMatch() {
						                    if (this.passwordConfirm === '') {
						                        this.passwordMatch = true;
						                        return;
						                    }
						                    this.passwordMatch = this.password === this.passwordConfirm;
						                }
						            }">
					{{ form_start(form, {'attr': {'class': 'space-y-6', 'enctype': 'multipart/form-data'}}) }}

					{# Pseudo #}
					<div>
						{{ form_label(form.username) }}
						{{ form_widget(form.username) }}
						<div class="text-red-600 text-xs mt-1">
							{{ form_errors(form.username) }}
						</div>
					</div>

					{# Email #}
					<div>
						{{ form_label(form.email) }}
						{{ form_widget(form.email) }}
						<div class="text-red-600 text-xs mt-1">
							{{ form_errors(form.email) }}
						</div>
					</div>

					{# Photo de profil #}
					<div>
						{{ form_label(form.avatarFile) }}
						{{ form_widget(form.avatarFile) }}
						<p class="text-xs text-gray-500 mt-1">JPG, PNG, GIF ou WEBP. Maximum 10 Mo.</p>
						<div class="text-red-600 text-xs mt-1">
							{{ form_errors(form.avatarFile) }}
						</div>
					</div>

					{# Section changement de mot de passe #}
					<div class="pt-6 border-t border-gray-200">
						<h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center gap-2">
							üîí Changer mon mot de passe
						</h3>
						<p class="text-sm text-gray-600 mb-4">
							Laissez ces champs vides si vous ne souhaitez pas modifier votre mot de passe.
						</p>

						<div
							class="space-y-4">
							{# Nouveau mot de passe #}
							<div>
								{{ form_label(form.plainPassword.first) }}
								{{ form_widget(form.plainPassword.first) }}
								<div class="text-red-600 text-xs mt-1">
									{{ form_errors(form.plainPassword.first) }}
								</div>
							</div>

							{# Confirmer le mot de passe #}
							<div>
								{{ form_label(form.plainPassword.second) }}
								{{ form_widget(form.plainPassword.second) }}
								<div class="text-red-600 text-xs mt-1">
									{{ form_errors(form.plainPassword.second) }}
								</div>
							</div>
							{# Indicateur de force du mot de passe #}
							<div x-show="password !== ''" class="p-3 bg-gray-50 rounded-lg border border-gray-200">
								<p class="text-xs font-semibold text-gray-700 mb-2">Le mot de passe doit contenir :</p>
								<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
									<ul class="space-y-1">
										<li class="flex items-center text-xs">
											<span x-show="!hasMinLength" class="text-red-500 mr-2">‚úó</span>
											<span x-show="hasMinLength" class="text-green-500 mr-2">‚úì</span>
											<span :class="hasMinLength ? 'text-green-700' : 'text-gray-600'">
												Au moins 6 caract√®res
											</span>
										</li>
										<li class="flex items-center text-xs">
											<span x-show="!hasUppercase" class="text-red-500 mr-2">‚úó</span>
											<span x-show="hasUppercase" class="text-green-500 mr-2">‚úì</span>
											<span :class="hasUppercase ? 'text-green-700' : 'text-gray-600'">
												Une majuscule (A-Z)
											</span>
										</li>
										<li class="flex items-center text-xs">
											<span x-show="!hasNumber" class="text-red-500 mr-2">‚úó</span>
											<span x-show="hasNumber" class="text-green-500 mr-2">‚úì</span>
											<span :class="hasNumber ? 'text-green-700' : 'text-gray-600'">
												Un chiffre (0-9)
											</span>
										</li>
									</ul>
									<ul class="space-y-1">
										<li class="flex items-center text-xs">
											<span x-show="!hasLowercase" class="text-red-500 mr-2">‚úó</span>
											<span x-show="hasLowercase" class="text-green-500 mr-2">‚úì</span>
											<span :class="hasLowercase ? 'text-green-700' : 'text-gray-600'">
												Une minuscule (a-z)
											</span>
										</li>
										<li class="flex items-center text-xs">
											<span x-show="!hasSpecial" class="text-red-500 mr-2">‚úó</span>
											<span x-show="hasSpecial" class="text-green-500 mr-2">‚úì</span>
											<span :class="hasSpecial ? 'text-green-700' : 'text-gray-600'">
												Un caract√®re sp√©cial (!@#$%&*_-)
											</span>
										</li>
									</ul>
								</div>

								{# Barre de progression #}
								<div class="mt-3">
									<div class="h-2 bg-gray-200 rounded-full overflow-hidden">
										<div class="h-full transition-all duration-300" :class="{
											                                            'bg-red-500': password.length > 0 && !isPasswordValid,
											                                            'bg-green-500': isPasswordValid,
											                                            'w-0': password.length === 0,
											                                            'w-1/5': hasMinLength && password.length > 0,
											                                            'w-2/5': hasMinLength && (hasUppercase || hasLowercase || hasNumber || hasSpecial),
											                                            'w-3/5': hasMinLength && ((hasUppercase && hasLowercase) || (hasNumber && hasSpecial)),
											                                            'w-4/5': (hasMinLength + hasUppercase + hasLowercase + hasNumber + hasSpecial) >= 4,
											                                            'w-full': isPasswordValid
											                                        }"></div>
									</div>
									<p x-show="isPasswordValid" class="text-xs text-green-600 font-semibold mt-1 text-center">
										‚úì Mot de passe fort !
									</p>
								</div>
							</div>

							{# V√©rification correspondance mots de passe #}
							<div x-show="passwordConfirm !== ''" class="p-3 rounded-lg border" :class="passwordMatch ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'">
								<div class="flex items-center text-xs">
									<span x-show="!passwordMatch" class="text-red-500 mr-2">‚úó</span>
									<span x-show="passwordMatch" class="text-green-500 mr-2">‚úì</span>
									<span :class="passwordMatch ? 'text-green-700' : 'text-red-700'">
										Les mots de passe correspondent
									</span>
								</div>
							</div>
						</div>
					</div>

					{# Bouton de soumission #}
					<div class="flex items-center justify-between pt-6">
						<button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200 shadow-md hover:shadow-lg cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed" :disabled="(password !== '' && (!isPasswordValid || !passwordMatch))">
							üíæ Enregistrer les modifications
						</button>
					</div>

					{{ form_end(form) }}
				</div>
			</div>
		</div>

		{# Zone de danger - Suppression du compte #}
		<div class="mt-8 bg-white rounded-xl shadow-lg overflow-hidden border-2 border-red-200">
			<div class="bg-red-50 px-8 py-4 border-b border-red-200">
				<h2 class="text-xl font-bold text-red-800">‚ö†Ô∏è Zone de danger</h2>
			</div>
			<div class="p-8">
				<h3 class="font-bold text-gray-900 mb-2">Supprimer mon compte</h3>
				<p class="text-sm text-gray-600 mb-4">
					Cette action est irr√©versible. Toutes vos donn√©es (stations visit√©es, badges, progression) seront d√©finitivement supprim√©es.
				</p>
				<form method="post" action="{{ path('app_profile_delete_account') }}" onsubmit="return confirm('‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\n\nToutes vos donn√©es seront d√©finitivement supprim√©es :\n‚Ä¢ Votre compte\n‚Ä¢ Vos badges\n‚Ä¢ Votre progression\n‚Ä¢ Vos stations visit√©es\n\n√ätes-vous VRAIMENT s√ªr de vouloir supprimer votre compte ?');">
					<input type="hidden" name="_token" value="{{ csrf_token('delete-account') }}">
					<button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 cursor-pointer">
						üóëÔ∏è Supprimer d√©finitivement mon compte
					</button>
				</form>
			</div>
		</div>
	</div>
{% endblock %}
